<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.iot.mapper.IotFirmwareMapper">
    <resultMap type="IotFirmware" id="IotFirmwareResult">
        <id     property="firmwareId"      column="firmware_id"      />
        <result property="firmwareVersion" column="firmware_version" />
        <result property="firmwareName"    column="firmware_name"    />
        <result property="description"    column="description"    />
        <result property="deviceType"     column="device_type"     />
        <result property="firmwarePath"    column="firmware_path"    />
        <result property="fileSize"       column="file_size"       />
        <result property="md5"            column="md5"            />
        <result property="status"         column="status"         />
        <result property="publishTime"    column="publish_time"    />
        <result property="createBy"       column="create_by"       />
        <result property="createTime"     column="create_time"     />
        <result property="updateBy"       column="update_by"       />
        <result property="updateTime"     column="update_time"     />
        <result property="remark"         column="remark"         />
    </resultMap>

    <sql id="selectIotFirmwareVo">
        select firmware_id, firmware_version, firmware_name, description, device_type, firmware_path, file_size, md5, status, publish_time, create_by, create_time, update_by, update_time, remark from iot_firmware
    </sql>

    <select id="selectIotFirmwareById" parameterType="Long" resultMap="IotFirmwareResult">
        <include refid="selectIotFirmwareVo" />
        where firmware_id = #{firmwareId}
    </select>

    <select id="selectIotFirmwareList" parameterType="IotFirmware" resultMap="IotFirmwareResult">
        <include refid="selectIotFirmwareVo" />
        <where>
            <if test="firmwareVersion != null and firmwareVersion != ''"> and firmware_version like concat('%', #{firmwareVersion}, '%')</if>
            <if test="deviceType != null and deviceType != ''"> and device_type like concat('%', #{deviceType}, '%')</if>
            <if test="status != null and status != ''"> and status = #{status}</if>
        </where>
        order by create_time desc
    </select>

    <insert id="insertIotFirmware" parameterType="IotFirmware" useGeneratedKeys="true" keyProperty="firmwareId">
        insert into iot_firmware
        (<if test="firmwareVersion != null">firmware_version,</if>
         <if test="firmwareName != null">firmware_name,</if>
         <if test="description != null">description,</if>
         <if test="deviceType != null">device_type,</if>
         <if test="firmwarePath != null">firmware_path,</if>
         <if test="fileSize != null">file_size,</if>
         <if test="md5 != null">md5,</if>
         <if test="status != null">status,</if>
         <if test="publishTime != null">publish_time,</if>
         <if test="createBy != null">create_by,</if>
         create_time, update_time)
        values
        (<if test="firmwareVersion != null">#{firmwareVersion},</if>
         <if test="firmwareName != null">#{firmwareName},</if>
         <if test="description != null">#{description},</if>
         <if test="deviceType != null">#{deviceType},</if>
         <if test="firmwarePath != null">#{firmwarePath},</if>
         <if test="fileSize != null">#{fileSize},</if>
         <if test="md5 != null">#{md5},</if>
         <if test="status != null">#{status},</if>
         <if test="publishTime != null">#{publishTime},</if>
         <if test="createBy != null">#{createBy},</if>
         sysdate(), sysdate())
    </insert>

    <update id="updateIotFirmware" parameterType="IotFirmware">
        update iot_firmware
        <set>
            <if test="firmwareVersion != null">firmware_version = #{firmwareVersion},</if>
            <if test="firmwareName != null">firmware_name = #{firmwareName},</if>
            <if test="description != null">description = #{description},</if>
            <if test="deviceType != null">device_type = #{deviceType},</if>
            <if test="firmwarePath != null">firmware_path = #{firmwarePath},</if>
            <if test="fileSize != null">file_size = #{fileSize},</if>
            <if test="md5 != null">md5 = #{md5},</if>
            <if test="status != null">status = #{status},</if>
            <if test="publishTime != null">publish_time = #{publishTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            update_time = sysdate()
        </set>
        where firmware_id = #{firmwareId}
    </update>

    <delete id="deleteIotFirmwareById" parameterType="Long">
        delete from iot_firmware where firmware_id = #{firmwareId}
    </delete>

    <delete id="deleteIotFirmwareByIds" parameterType="Long[]">
        delete from iot_firmware where firmware_id in 
        <foreach item="firmwareId" collection="array" open="(" separator="," close=")">
            #{firmwareId}
        </foreach>
    </delete>

    <select id="selectLatestFirmwareByDeviceType" parameterType="String" resultMap="IotFirmwareResult">
        <include refid="selectIotFirmwareVo" />
        where device_type = #{deviceType} and status = '1' order by publish_time desc limit 1
    </select>
</mapper>